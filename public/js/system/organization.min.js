/**
 * Admui-iframe v2.1.0 (http://www.admui.com/)
 * Copyright 2015-2019 Admui Team
 * Licensed under the Admui License 1.1 (http://www.admui.com/about/license)
 */
!function(e,o,u){var n,p,r,c,i=function(r){var e={types:{default:{icon:"fa-building-o"}},search:{show_only_matches:!0,show_only_matches_children:!0},plugins:["types","wholerow","search"],core:{check_callback:!0,data:function(e,a){u.ajax({url:n+"/public/data/system/org/trees.json",traditional:!0,dataType:"JSON",success:function(e){var t;e.success?(t=e.data,u.each(t,function(e,t){"display"===r&&0===e&&(t.state={selected:!0})}),a.call(this,t)):toastr.error(e.msg)},error:function(e){toastr.error(e)}})}}};return"modify"===r&&(e.plugins.push("checkbox"),e.checkbox={three_state:!1}),e};o.App.extend({run:function(){var e=this;p=this.getOperPermission(),this.departmentFn(),this.memberFn(),u("#queryRole").select2(u.concatCpt("select2",{minimumResultsForSearch:20,ajax:{url:n+"/role/trees",data:function(e){return{name:e.term}},processResults:function(e){return e.data.unshift({id:"",text:"所有角色"}),{results:e.data}}}})).on("change",function(){e.table.ajax.reload()}),u("#queryStatus").on("change",function(){e.table.ajax.reload()}),u("#searchMember").on("change",function(){e.table.ajax.reload()})},departmentFn:function(){var t=this,a={type:""};r.jstree(i("display")).on("ready.jstree",function(){(c=u(this).jstree(!0)).open_all(),t.table=t.memberTable(u("#memberTable"))}).on("select_node.jstree",function(){t.table.ajax.reload(),u("#memberTable").find(".selectable-all").prop("checked",!1)}),u("#departmentSearch").on("keyup",function(){c.search(u(this).val())}),u(".add-dep").on("click",function(){a.type=""}),u(".add-child-dep").on("click",function(){var e=t.getDeInfo();u.extend(a,{type:"child",depName:e.name,depId:e.id})}),u("#departmentModal").on("show.bs.modal",function(){u(this).find(".modal-content").html(template("departmentTpl",a))}).on("shown.bs.modal",function(){"child"!==a.type&&u(this).on("shown.bs.dropdown",".choose-dep",function(){var e=u(this).find(".choose-dep-tree");!e.jstree(!0)&&e.jstree(i()).on("ready.jstree",function(){u(this).jstree(!0).open_all(),e.parent().mCustomScrollbar(u.concatCpt("mCustomScrollbar"))})}).on("click",".choose-dep>.dropdown-menu",function(e){var t,a,r=u(e.target),s=u(".choose-dep"),o=s.find('>[data-toggle="dropdown"]');r.is("a.jstree-clicked")&&(t=r.text(),a=r.parent("li").attr("id"),o.dropdown("toggle").val(t),s.find('>[name="parentId"]').val(a),s.closest("form").validate().element(o)),e.stopPropagation()}),u("#addDepartment").validate({rules:{orgName:{required:!0}},submitHandler:function(e){var t=u(e).serializeObject();delete t.parentName,u.ajax({url:n+"/org",type:"POST",dataType:"JSON",data:JSON.stringify(t),contentType:"application/json",success:function(e){var t;e.success?(t=e.data,toastr.success(e.msg),u("#departmentModal").modal("hide"),"0"===t.parentId&&(t.parentId="#"),c.create_node(t.parentId,{id:t.id,text:t.orgName})):toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})}})}),u(".alter-dep").on("click",function(){var e=t.getDeInfo(),s=e.id;o.top.layer.prompt({title:"修改部门名称",value:e.name},function(e,t,a){var r;e&&(r={id:s,orgName:e},u.ajax({url:n+"/org",type:"POST",dataType:"JSON",data:JSON.stringify(r),contentType:"application/json",success:function(e){e.success?(c.rename_node(c.get_selected(),e.data.orgName),toastr.success(e.msg),o.top.layer.close(t)):toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})),a.preventDefault()})}),u(".del-dep").on("click",function(){var a=t.getDeInfo().id,r=c.get_selected(!0)[0];0<t.depMembers?toastr.warning("该部门有成员，不能被删除！"):0<r.children.length?toastr.warning("该部门下有子部门，不能被删除！"):((r=c.get_next_dom(a,!0))||(r=c.get_prev_dom(a,!0)),r||(r=c.get_parent(a)),"#"!==r?o.top.layer.confirm("您确定要删除该部门吗？",function(t){u.ajax({url:n+"/org/"+a,type:"DELETE",dataType:"JSON",success:function(e){e.success?(c.delete_node(a),c.select_node(r),toastr.success(e.msg),o.top.layer.close(t)):toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})}):toastr.warning("不能删除唯一部门！"))})},memberFn:function(){var r=this,s={type:"edit"},a=u("#multipleEditDep");u("#addmember").on("click",function(){s={type:"create"}}),u(e).on("click",".edit-member",function(){var e=u(this).parent().parent().data("id");u.ajax({url:n+"/public/data/system/user/"+e+".json",type:"GET",dataType:"JSON",success:function(e){e.success?(u.extend(s,e.data,{type:"edit"}),u("#memberModal").modal("show")):toastr.error(e.msg)},error:function(e){toastr.error(e)}})}),u("#memberModal").on("show.bs.modal",function(){u(this).find(".modal-dialog").html(template("memberTpl",s))}).on("shown.bs.modal",function(){var o,e={userName:{required:!0},password:{required:!0,minlength:6,maxlength:30},name:{required:!0},userType:{required:!0},position:{required:!0},mobile:{required:!0,mobileCN:!0},email:{email:!0},telephone:{phoneCN:!0},phoneExt:{number:!0},jobNum:{required:!0},remark:{maxlength:500},department:{required:!0},role:{required:!0}},t=s.type,a="已选择所属部门";"edit"===t&&(e.password.required=!1),u("#memberForm").validate({ignore:"",rules:e,invalidHandler:function(e,t){var a=u(t.errorList[0].element),r=u("#baseInfo"),s=u("#deptJob");0<r.find(a).length&&!r.hasClass("active")&&u('a[href="#baseInfo"]').tab("show"),0<s.find(a).length&&!s.hasClass("active")&&u('a[href="#deptJob"]').tab("show")},submitHandler:function(e){var t=u(e).serializeObject();delete t.role,delete t.department,t.roleIds=JSON.parse(t.roleIds),t.orgIds=JSON.parse(t.orgIds),u.ajax({url:n+"/user",type:"POST",dataType:"JSON",data:JSON.stringify(t),contentType:"application/json",success:function(e){e.success?(toastr.success(e.msg),r.table.ajax.reload(),u("#memberModal").modal("hide")):toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})}}),u("#deptJob").on("shown.bs.dropdown",".choose-dep",function(){!(o=u(this).find(".choose-dep-tree")).jstree(!0)&&o.jstree(i()).on("ready.jstree",function(){u(this).jstree(!0).open_all(),u(this).parent().mCustomScrollbar(u.concatCpt("mCustomScrollbar")),"edit"===t&&0<s.orgs.length&&u.each(s.orgs,function(e,t){o.find("#"+t.orgId+">a").addClass("jstree-selected")})})}).on("hidden.bs.dropdown",".choose-dep",function(e){var t,a=u(this),r=a.find('>[data-toggle="dropdown"]'),s=[];o.find("a.jstree-selected").each(function(){s.push(u(this).parent().attr("id"))}),1<s.length?t="已选择所属部门":1===s.length&&(t=o.find("#"+s[0]+">a").text()),r.val(t),a.find("#orgIds").val(JSON.stringify(s)),a.closest("form").validate().element(r),e.stopPropagation()}).on("click",".choose-dep>.dropdown-menu",function(e){var t=u(e.target);t.is("a.jstree-clicked")&&(t.hasClass("jstree-selected")?t.removeClass("jstree-selected"):t.addClass("jstree-selected"),e.stopPropagation())}),u("#role").select2(u.concatCpt("select2",{multiple:!0,closeOnSelect:!1,ajax:{url:n+"/role/trees",processResults:function(e){return{results:e.data}}}})).on("select2:select select2:unselect",function(){var e=u(this);e.siblings('[name="roleIds"]').val(JSON.stringify(e.val())),e.closest("form").validate().element(e)}),"edit"===t&&0<s.roles.length&&u.each(s.roles,function(e,t){u("#role").append(new Option(t.roleName,t.id,!0,!0)).trigger("select2:select")}),"edit"===t&&0<s.orgs.length&&(1===s.orgs.length&&(a=s.orgs[0].orgName),u("#department").val(a))}),u(e).on("click",".del-member",function(){var a=u(this).parent().parent().data("id");o.top.layer.confirm("你确定要删除该成员吗？该操作将彻底销毁该成员，请谨慎操作！",function(t){u.ajax({url:n+"/user/U",type:"DELETE",data:JSON.stringify({masterId:c.get_selected()[0],itemIds:[a]}),contentType:"application/json",dataType:"JSON",success:function(e){e.success?(r.table.row("#"+a).remove().draw(!1),toastr.success(e.msg),o.top.layer.close(t)):toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})})}),u(e).on("click",".remove-member",function(){var a=u(this).parent().parent().data("id");o.top.layer.confirm("你确定要从当前部门中移除该成员吗？",function(t){u.ajax({url:n+"/user/R",type:"DELETE",data:JSON.stringify({masterId:c.get_selected()[0],itemIds:[a]}),contentType:"application/json",dataType:"JSON",success:function(e){e.success?(r.table.row("#"+a).remove().draw(!1),toastr.success(e.msg),o.top.layer.close(t)):toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})})}),u(e).on("click",".disable-member",function(){var a=u(this),r=a.parent().parent().data("id");o.top.layer.confirm("你确定禁用该成员吗？",function(t){u.ajax({url:n+"/user/1",type:"POST",data:JSON.stringify([r]),contentType:"application/json",dataType:"JSON",success:function(e){e.success?(a.closest("table").find("#"+r).addClass("table-disabled").find(":checkbox").prop({disabled:!0,checked:!1}),a.removeClass("disable-member").addClass("enable-member").text("启用成员"),toastr.success(e.msg),o.top.layer.close(t)):toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})})}),u(e).on("click",".enable-member",function(){var a=u(this),r=a.parent().parent().data("id");o.top.layer.confirm("你确定启用该成员吗？",function(t){u.ajax({url:n+"/user/0",type:"POST",data:JSON.stringify([r]),contentType:"application/json",dataType:"JSON",success:function(e){e.success?(a.closest("table").find("#"+r).removeClass("table-disabled").find(":checkbox").prop("disabled",!1),a.removeClass("enable-member").addClass("disable-member").text("禁用成员"),toastr.success(e.msg),o.top.layer.close(t)):toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})})}),u(e).on("click",".modify-selected-item",function(){0!==u("#memberTable").asSelectable("getSelected").length?u("#deptPicker").modal("show"):toastr.warning("请先选择成员！")}),u("#deptPicker").on("shown.bs.modal",function(){a.jstree(!0)||a.jstree("destroy").jstree(i("modify")).on("ready.jstree",function(){u(this).jstree(!0).open_all()}).on("changed.jstree",function(e,t){var a=u(".selected_dep"),r=t.node;"select_node"!==t.action&&"deselect_node"!==t.action||("select_node"===t.action?a.append('<a class="list-group-item" href="javascript:;" title="'+r.text+'" data-id="'+r.id+'"><i class="icon wb-folder"></i><span>'+r.text+'</span><i class="icon wb-close delete-item"></i></a>'):a.find('[data-id="'+r.id+'"]').remove())})}).on("hidden.bs.modal",function(){a.jstree(!0).redraw(!0),u(".selected_dep").html("")}).on("click",".change-deps",function(){var e=a.jstree(!0).get_selected(),t=[];u("#memberTable").asSelectable("getSelected").each(function(){t.push(u(this).closest("tr").attr("id"))}),0!==e.length?u.ajax({url:n+"/user/updateuserdept",type:"POST",data:JSON.stringify({masterIds:e,itemIds:t}),dataType:"json",contentType:"application/json",success:function(e){e.success?(toastr.success(e.msg),r.table.ajax.reload(),u("#deptPicker").modal("hide")):toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}}):toastr.warning("您需要选择一个部门！")}).on("click",".delete-item",function(){var e=u(this).closest("a");a.jstree(!0).deselect_node(e.data("id")),e.remove()}).on("keyup",".search-dep",function(){a.jstree(!0).search(u(this).val())}),u(e).on("click",".disable-selected-item",function(){var a=u("#memberTable").asSelectable("getSelected"),e=r.selectedMember(a);e?o.top.layer.confirm("您确定要禁用所有选中成员吗？",function(t){u.ajax({url:n+"/user/1",type:"POST",data:JSON.stringify(e),traditional:!0,contentType:"application/json",dataType:"JSON",success:function(e){e.success?(a.each(function(){var e=u(this),t=e.closest("tr");e.prop({disabled:!0,checked:!1}),t.addClass("table-disabled"),t.find(".disable-member").removeClass("disable-member").addClass("enable-member").text("启用成员")}),toastr.success(e.msg),o.top.layer.close(t)):toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})}):toastr.warning("请先选择成员！")})},selectedMember:function(e){var t=[];return 0!==e.length&&(e.each(function(){t.push(u(this).closest("tr").attr("id"))}),t)},memberTable:function(e){var o=this;return e.asSelectable(u.concatCpt("selectable")),e.DataTable(u.concatCpt("dataTable",{dom:'<"row"<"col-lg-12"tr>><"row table-toolbar"<"col-sm-7"l><"col-sm-5"p>>',autoWidth:!0,processing:!0,serverSide:!0,searching:!0,pagingType:"simple_numbers",rowId:"id",columns:[{render:function(){return'<div class="checkbox-custom checkbox-primary user-select-item"><input type="checkbox" class="user-checkbox selectable-item"><label></label></div>'}},{data:"name"},{data:"sexName"},{data:"orgNames",render:function(e){return'<span class="inline-block text-truncate w-200">'+e+"</span>"}},{data:"roleNames",render:function(e){return'<span class="inline-block text-truncate w-200">'+e+"</span>"}},{data:"mobile"},{data:"userName"},{data:"email"},{render:function(e,t,a){var s,r={selector:"disable-member"},o="",n=function(a){var r=!1;return u.each(p,function(e,t){if(t.id===a)return s=t,!(r=!0)}),r},c="",i="",d="",l="";return n("500019")&&(c='<a href="javascript:;" class="dropdown-item edit-member">'+s.name+"</a>"),n("500011")&&(r.text=s.name,1===a.status&&(r.selector="enable-member",r.text="启用成员"),i='<a href="javascript:;" class="dropdown-item '+r.selector+'">'+r.text+"</a>"),n("500017")&&(d='<a href="javascript:;" class="dropdown-item remove-member">'+s.name+"</a>"),n("500021")&&(l='<a href="javascript:;" class="dropdown-item del-member">'+s.name+"</a>"),void 0!==s&&(o='<div class="btn-group user-edit" data-id="'+a.id+'"><button type="button" class="btn btn-outline btn-default dropdown-toggle btn-xs" id="exampleSizingDropdown4" data-toggle="dropdown" aria-expanded="true">编辑 </button><div class="dropdown-menu dropdown-menu-right"> '+c+i+d+l+"</div></div>"),o}}],rowCallback:function(e,t){1===t.status&&u(e).addClass("table-disabled").find("input:checkbox").prop("disabled",!0)},ajax:function(e,a){var r=o.getDeInfo(),t=r.id,s={pageIndex:e.start/e.length+1,pageSize:e.length,data:{orgId:t,roleId:u("#queryRole").val(),status:u("#queryStatus").val(),name:u("#searchMember").val()}};u.ajax({url:n+"/public/data/system/user/users.json",type:"GET",dataType:"JSON",data:s,success:function(e){var t={recordsTotal:e.total,recordsFiltered:e.total,data:e.pageList};o.depMembers=e.total,a(t),u("#depMsg").find(">span").text(r.name+"("+e.total+")")},error:function(e){toastr.error(e)}})}}))},getDeInfo:function(){var e=c.get_selected(!0)[0];return{id:e.id,name:e.text}}}),u(function(){n=u.configs.ctx,r=u("#departmentJstree"),o.App.run()})}(document,window,jQuery);