/**
 * Admui-iframe v2.1.0 (http://www.admui.com/)
 * Copyright 2015-2019 Admui Team
 * Licensed under the Admui License 1.1 (http://www.admui.com/about/license)
 */
!function(a,r,u){"use strict";var l,s,c,o,p,m=u.configs.ctx;r.App.extend({run:function(){var d=this,i=0;d.menuObj=[],p=this.getOperPermission(),this.topMenusInit(),u("#saveChlidMenu").on("click",function(){d.saveMenu()}),u(a).on("click",".top-menu .list-group-item",function(){var e=u(this),t=function(){e.siblings("[data-children]").removeClass("active"),e.addClass("active"),d.submenuRender(e.data("children"))};e.hasClass("active")||(d.subType?(r.top.layer.confirm("您还未对修改过的信息进行保存，请先进行保存！",{btn:["保存","不保存"]},function(a){d.saveMenu(),r.top.layer.close(a)},function(a){d.subType=void 0,d.menuObj=d.getMenuData(e),t(),r.top.layer.close(a)}),i=0):(d.subType=void 0,d.menuObj=d.getMenuData(e),t()))}),o.on("click",function(){"xs"===Breakpoints.current().name&&u(".page-aside").removeClass("open")}),u(a).on("click",'[data-tag="list-editable"], #addMenuToggle',function(a){var e,t=u(this),n=d.getMenuData(t.parents("[data-children]"));t.is('[data-tag="list-editable"]')?u.extend(n,{type:"edit"}):n.icon="fa-bars",e=template("selectOption",n),c.find(".modal-content").html(e),c.modal("show"),u(".icp-dd").iconpicker(u.concatCpt("iconpickerWb")).on("iconpickerSelected",function(a){u(this).prev("span").children("i[data-icon]").data("icon",a.iconpickerValue).attr("data-icon",a.iconpickerValue)}),d.topMenuValidate(n.id),a.stopPropagation()}),u(a).on("click",'[data-tag="list-delete"]',function(a){var t=u(this).parents("div[data-children]"),n=t.data("id");0!==t.siblings("[data-children]").length?(r.top.layer.confirm("您确定要删除该菜单吗？",function(e){u.ajax({url:m+"/menu/"+n,type:"DELETE",dataType:"JSON",success:function(a){a.success?(t.is(".active")&&(0<t.next().length?t.next().addClass("active"):t.prev().addClass("active"),d.submenuRender(t.siblings(".active").data("children"))),t.remove(),toastr.success(a.msg),r.top.layer.close(e)):toastr.error(a.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})}),a.stopPropagation()):r.top.layer.alert("您必须保留一个菜单！")}),u(a).on("click","#menuTree .dd-content:not(.active)",function(){var a=u(this).parent("li");l.find(".active").removeClass("active"),a.find(">.dd-content").addClass("active"),d.submenuEditPanel(d.getMenuData(a))}),u(a).on("focusout",'input[name="submenu_name"]',function(){var a,e=u(this).val(),t=l.find(".active").parent("li"),n=t.data("name");e!==n&&(""===e?e=n:(d.subType="change",t.data("name",e).attr("data-name",e),""!==t.data("icon")?(a=t.data("icon"),t.children("div.dd-content").children("span.menu-name").html('<i class="menu-icon '+a+'"></i> '+e)):t.children("div.dd-content").children("span.menu-name").text(e),u(".menu-box h4").text(e),"add"!==t.data("type")&&t.data("type","update").attr("data-type","update")),u(this).val(e))}),u(a).on("focusout",'input[name="submenu_url"]',function(){var a=u(this).val(),e=l.find(".active").parent("li"),t=e.data("url");""===a?a=t:(d.subType="change",e.data("url",a).attr("data-url",a),"add"!==e.data("type")&&e.data("type","update").attr("data-type","update")),u(this).val(a)}),u(a).on("click",".delete-submenu",function(){var a,e=!1,t=l.find(".active").parent("li"),n=t.data("id"),i=function(){if(0<t.next().length?t.next().children(".dd-content").addClass("active"):0<t.prev().length?t.prev().children(".dd-content").addClass("active"):(t.parent("ol").closest("li").children(".dd-content").addClass("active"),t.parent("ol").remove(),e=!0),t.remove(),toastr.success("菜单删除成功！"),a=d.getMenuData(l.find(".active").parent("li")),e&&(a.url="#"),0===l.find("li").length)return s.find(">.list-group-item.active").data("children","null").attr("data-children","null"),void d.updateSubmenuPanel(null);d.submenuEditPanel(a)};r.top.layer.confirm("您确定要删除该菜单吗？",function(a){n?u.ajax({url:m+"/menu/"+n,type:"DELETE",dataType:"JSON",success:function(a){a.success?i():toastr.error(a.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}}):1<l.find("li").length?i():(d.subType="",t.remove(),d.updateSubmenuPanel(null)),r.top.layer.close(a)})}),u(a).on("click",".add-submenu",function(){var a,e,t,n=u(this);if(i+=1,d.subType="change",o.hasClass("vertical-align"))return a=[{name:"自定义菜单一",type:"add",url:"#"}],void d.submenuRender(a);t=(e=l.find(".active").parent("li")).data("rank"),void 0===d.insertChildMenu(n,e,t,i)&&(a=d.getMenuData(l.find(".active").parent("li")),d.submenuEditPanel(a))})},updateTopMenuOrder:function(a){var e=[];a.children(".list-group-item").each(function(){e.push({id:u(this).data("id"),orderNo:u(this).index()})}),u.ajax({url:m+"/menu/updatetoporder",type:"POST",data:JSON.stringify(e),dataType:"JSON",contentType:"application/json",success:function(a){a.success?toastr.success("重新登录可更新顶部菜单！"):toastr.error(a.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})},saveMenu:function(){var e=this;this.menuObj.children=l.nestable("serialize"),u.ajax({url:m+"/menu",type:"POST",data:JSON.stringify(this.menuObj),dataType:"JSON",contentType:"application/json;",success:function(a){a.success?(e.subType=void 0,toastr.info("当前菜单保存成功，重新登录可更新菜单数据！"),r.location.reload(!0)):toastr.error(a.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})},getMenuData:function(a){return{id:a.data("id"),url:a.data("url"),name:a.data("name")||"自定义菜单",icon:a.data("icon"),layer:a.data("layer")}},updateTopMenu:function(a,e){var t,n=a;if(e){if((t=s.find('>[data-id="'+e+'"]')).data({name:n.name,icon:n.icon}).attr({"data-name":n.name,"data-icon":n.icon}),t.find(".top_menuname").text(n.name),t.find("i.topmenu-icon").removeClass().addClass("icon "+n.icon),!t.hasClass("active"))return;this.updateSubmenuPanel(t.data("children"))}else u(".top-menu > [data-children].active").removeClass("active"),this.topMenuRender([n])},topMenusInit:function(){var e=this;u.ajax({url:m+"/public/data/system/menu/trees.json",dataType:"JSON",success:function(a){a.success?e.topMenuRender(a.data):toastr.warning(a.msg)},error:function(){toastr.error("服务器异常，请稍后再试！")}})},topMenuRender:function(a){var e,t=this,n={};n.navMenus=a,template.defaults.imports.json_str=function(a){return JSON.stringify(a)},template.defaults.imports.operate_permission=function(t){var n=!1;return u.each(p,function(a,e){if(e.id===t)return!(n=!0)}),n},e=template("navMenu",n),s.append(e),sortable(s,{disableIEFix:!0})[0].addEventListener("sortupdate",function(){t.updateTopMenuOrder(u(this))}),this.submenuRender(s.children(".list-group-item.active").data("children")),"add"!==this.menuObj.type&&(this.menuObj=this.getMenuData(s.children("div[data-children].active")))},updateSubmenuPanel:function(a){var e=s.find(">.list-group-item.active"),t=o.children(".no-submenu"),n=o.children(".page-content");_.isNull(a)?(o.hasClass("vertical-align")||(o.removeClass("has-submenu").addClass("vertical-align"),n.hide(),t.removeAttr("hidden")),t.find("i.topmenu-icon").addClass(e.data("icon")),t.find(".nav-menu-name").html(e.data("name"))):(t.attr("hidden",!0),o.addClass("has-submenu").removeClass("vertical-align"),n.show(),t.find("i").removeClass().addClass("icon topmenu-icon"))},submenuRender:function(a){var e,t,c,o=this,n=a;this.updateSubmenuPanel(n),l=u("#menuTree .menu-tree"),e=template("childMenu",{menus:n}),l.html(e),l.nestable(u.concatCpt("nestable",{callback:function(a,d){var r,s,e=d;s=e.index(),void 0===function a(e){var t=e.parent().closest("li").data("rank"),n=c.data("id"),i=e.parent().closest("li").data("id");if(t=_.isNaN(t)?2:t+1,void 0===r&&(r=t,o.dataRank===r&&o.subMenuIndex===s&&n===i))return!1;e.data("rank",t).attr("data-rank",t),3!==t?(e.data("icon","").attr("data-icon",""),e.children(".dd-content").find("i.menu-icon").remove()):""===d.data("icon")&&(e.data("icon","fa-bars").attr("data-icon","fa-bars"),e.children(".dd-content").find("span.menu-name").prepend("<i class='menu-icon fa-bars'></i> ")),2===t?e.data("url","").attr("data-url",""):d.find("li").length<1&&""===e.data("url")&&e.data("url","#").attr("data-url","#"),0<e.children("ol>li[data-name]").length&&e.children("ol").children("li[data-name]").each(function(){a(u(this))})}(e,o.dataRank)&&(o.subType="change","add"!==e.data("type")&&e.data("type","update").attr("data-type","update"),""!==e.parent("ol").closest("li").data("url")&&e.parent("ol").closest("li").data({url:"",type:"update"}).attr({"data-url":"","data-type":"update"}),c.find("li").length<1&&c.data({url:"#",type:"update"}).attr({"data-url":"#","data-type":"update"}),o.submenuEditPanel(o.getMenuData(l.find(".active").parent("li"))))},onDragStart:function(a,e){var t=e;o.subMenuIndex=t.index(),o.dataRank=t.data("rank"),c=t.parent().closest("li")}})),t=this.getMenuData(l.find(".active").parent("li")),this.submenuEditPanel(t)},submenuEditPanel:function(a){var n=this,e=template("menuInfo",a);u(".menu-info").html(e),u(".icp-dd1").iconpicker(u.concatCpt("iconpicker")).on("iconpickerSelected",function(a){var e=a.iconpickerValue,t=l.find(".active").parent("li");n.subType="change",t.data("icon",e).attr("data-icon",e),t.find("i.menu-icon").removeClass().addClass("menu-icon "+e),"add"!==t.data("type")&&t.data("type","update").attr("data-type","update")})},insertChildMenu:function(a,e,t,n){var i=t,d=n,r=function(a){return a?'<li class="dd-item dd-item-alt" data-id="" data-rank="'+i+'" new-build="'+d+'" data-name="自定义菜单" data-url="#" data-icon="fa-bars" data-type="add"><div class="dd-handle"></div><div class="dd-content active"><span class="menu-name"><i class="menu-icon fa-bars"></i> 自定义菜单</span><span class="float-right fa-angle-right"></span></div></li>':'<li class="dd-item dd-item-alt" data-id="" data-rank="'+i+'" new-build="'+d+'" data-name="自定义菜单" data-url="#" data-icon="" data-type="add"><div class="dd-handle"></div><div class="dd-content active"><span class="menu-name">自定义菜单</span><span class="float-right fa-angle-right"></span></div></li>'};if(a.hasClass("after")&&(3===i?e.after(r("icon")):e.after(r())),a.hasClass("append")){if(5<=i)return toastr.warning("已经是最后一级菜单，不能再为其添加子菜单了！"),d-=1,!1;0===e.find("ol").length&&(e.append('<ol class="dd-list"></ol>'),e.data("url","").attr("data-url","")),3===(i=Number(i)+1)?e.children("ol").append(r("icon")):e.children("ol").append(r())}l.find(".active:first").removeClass("active")},topMenuValidate:function(n){var i=this,d=u("#controlMenu").validate({rules:{menu_name:{required:!0}},messages:{menu_name:{required:"请填写菜单名称"}},submitHandler:function(a){var e=u(a),t={id:n,name:e.find('[name="menu_name"]').val(),icon:e.find("i[data-icon]").data("icon")};u.ajax({url:m+"/menu",type:"POST",contentType:"application/json;",data:JSON.stringify(t),dataType:"JSON",success:function(a){a.success?(n?u.extend(!0,i.menuObj,t):(u.extend(t,{id:a.data.id,layer:a.data.layer,children:a.data.children}),i.menuObj=t),toastr.info("修改成功，重新登录可更新顶部菜单！"),c.one("hidden.bs.modal",function(){i.updateTopMenu(t,n),d.resetForm()}).modal("hide")):toastr.error(a.msg)},error:function(a){toastr.error(a)}})}})}}),u(function(){s=u(".top-menu"),c=u("#addMenu"),o=u(".page-main"),r.App.run()})}(document,window,jQuery);