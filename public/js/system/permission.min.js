/**
 * Admui-iframe v2.1.0 (http://www.admui.com/)
 * Copyright 2015-2019 Admui Team
 * Licensed under the Admui License 1.1 (http://www.admui.com/about/license)
 */
!function(p,s,l){p.App.extend({run:function(){var i,r,n=l.configs.ctx,o=l("body"),c=l("#permissionLists"),d=[],e=this.getOperPermission(),t=function(s){var e="新增权限",t="",a=s.data("type");"edit"===a&&(e="修改权限名称",t=s.closest(".list-group-item").data("text")),p.top.layer.prompt({title:e,value:t},function(e,t){e&&l.ajax({url:n+"/permission",type:"POST",data:JSON.stringify({id:s.closest(".list-group-item").attr("id"),name:e}),dataType:"JSON",contentType:"application/json",success:function(e){if(e.success){if(toastr.success(e.msg),"edit"===a)return void s.closest(".list-group-item").data("text",e.data.name).addBack().find("span.list-text").text(e.data.name);o.addClass("page-aside-fixed page-aside-left").find(".page>.page-content").attr("hidden",!0).addBack().siblings().attr("hidden",!1),c.append(template("permissionItemTpl",{permissionLists:[e.data]})),p.top.layer.close(t)}else toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})})};template.defaults.imports.operate_permission=function(s){var a=!1;return l.each(e,function(e,t){if(t.id===s)return!(a=!0)}),a},l("#menuTree").data("jstree",!1).empty().jstree({checkbox:{keep_selected_style:!1},plugins:["checkbox","search"],core:{data:function(e,t){l.ajax({url:n+"/public/data/system/menu/authmenutrees.json",type:"GET",traditional:!0,dataType:"JSON",success:function(e){e.success?t.call(this,e.data):toastr.error(e.msg)},error:function(e){toastr.error(e)}})}}}).on("ready.jstree",function(){var t=l(this);(i=t.jstree(!0)).open_all(),t.find("a").on("click",function(){var e=l(this),t=c.find(">.list-group-item.active").attr("id"),s=e.closest("li").attr("id");r="change",l("#menuTree").find("a.active").removeClass("active"),i.is_selected(s)?l("#operatePermissions").html(template("operatePermissionTpl",{type:"deselected"})):(e.closest("a").addClass("active"),l.ajax({url:n+"/public/data/system/operation/operations.json",type:"GET",data:{permissionId:t,menuId:s},dataType:"JSON",success:function(e){e.success?l("#operatePermissions").html(template("operatePermissionTpl",{operatePermissions:e.data})):toastr.err(e.msg)},error:function(e){toastr.error(e)}}))}),l.ajax({url:n+"/public/data/system/permission/permissions.json",type:"GET",dataType:"JSON",success:function(e){e.success?0<e.data.length&&(c.html(template("permissionItemTpl",{permissionLists:e.data})),o.addClass("page-aside-fixed page-aside-left").find(".page>.page-content").attr("hidden",!0).addBack().siblings().attr("hidden",!1),c.find(".list-group-item:first").addClass("active"),d=c.find(".list-group-item:first").data("operIds"),i.select_node(e.data[0].menuIds),t.find("a:first>span").trigger("click")):toastr.err(e.msg)},error:function(e){toastr.error(e)}})}),c.on("click",".list-group-item",function(e){var t=l(this),s=l(e.target).parent(),a=function(){t.siblings().removeClass("active"),t.addClass("active"),l("#menuTree").find("a:first>span").trigger("click"),d=t.data("operIds"),i.deselect_all(),i.select_node(t.data("menus"))};s.is(".delete-item")||s.is(".alter-item")||t.hasClass("active")||("change"===r?p.top.layer.confirm("当前权限项修改数据未保存，切换权限会清空数据，您确定切换吗？",function(e){a(),r="",p.top.layer.close(e)}):a())}),l(".add-permission").on("click",function(){t(l(this))}),l(s).on("click",".alter-item",function(){t(l(this))}),l(s).on("click",".delete-item",function(){var s=l(this).closest(".list-group-item"),e=s.attr("id");p.top.layer.confirm("您确定要删除当前项吗？",function(t){l.ajax({url:n+"/permission/"+e,type:"DELETE",dataType:"JSON",success:function(e){e.success?(toastr.success(e.msg),0===s.siblings().length?o.removeClass("page-aside-fixed page-aside-left").find(".page>.page-content").attr("hidden",!1).addBack().siblings().attr("hidden",!0):s.hasClass("active")&&(0<s.next().length?s.next().trigger("click"):s.prev().trigger("click")),s.remove(),toastr.success(e.msg),p.top.layer.close(t)):"1001"===e.code?toastr.warning(e.msg):toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})})}),l(s).on("change",'[name="operatePer"]',function(){var e=l(this),t=e.attr("id");r="change",e.prop("checked")&&-1===d.indexOf(t)&&d.push(t),e.prop("checked")||d.splice(d.indexOf(t),1)}),l("#savePermission").on("click",function(){l.ajax({url:n+"/permission/assign",type:"POST",data:JSON.stringify({permissionId:c.find(">.list-group-item.active").attr("id"),menuIds:i.get_selected().concat(i.get_undetermined()),operationIds:d}),dataType:"JSON",contentType:"application/json",success:function(e){e.success?p.location.reload(!0):toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请配合后端程序使用")}})})}}),l(function(){p.App.run()})}(window,document,jQuery);