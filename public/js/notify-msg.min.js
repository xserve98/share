/**
 * Admui-iframe v2.1.0 (http://www.admui.com/)
 * Copyright 2015-2019 Admui Team
 * Licensed under the Admui License 1.1 (http://www.admui.com/about/license)
 */
!function(c,e,f){var t=f.configs.ctx,a={init:function(){var o=this,u=f("#admui-navbarMessage").find("span.msg-num"),e=new WebSocket("ws://"+c.location.host+t+"/socket");e.onopen=function(){e.send("发送数据")},e.onmessage=function(e){var t=null,a="",n=null,s=0,i=c.notifyFn.unReadMsg,r=JSON.parse(e.data);if(r.status)return s=o.firstMsg(r.total,u),void(i&&f.isFunction(i)&&i(s));t=c.notifyFn.messagePage,n=c.notifyFn.messageNum,a=u.data("message")+1,u.data("message",a),99<a&&(a="99+"),u.text(a),toastr.options={positionClass:"toast-bottom-right",onclick:function(){o.readMsg(r)}},toastr.clear(),toastr.info(r.title),f("#admui-navbarMessage ul").is(":visible")&&o.loading(),t&&f.isFunction(t)&&t(o),n&&f.isFunction(n)&&n("1")},e.onclose=function(e){toastr.info("消息通知服务已关闭",e)}},firstMsg:function(e,t){var a;return a=0===e?"":99<e?"99+":e,t.data("message",e).text(a),a},readMsg:function(s){var i=f("#admui-navbarMessage").find("span.msg-num"),r=Number(i.data("message"));toastr.clear(),layer.alert(s.content,{size:"small",title:s.title}),s.readFlag||f.ajax({url:t+"/message/"+s.messageId,type:"POST",dataType:"JSON",success:function(e){var t=0,a=c.notifyFn.msgStatus,n=c.notifyFn.messageNum;e.success?(99<(t=r-=1)?t="99+":0===t&&(t=""),i.data("message",r).text(t),a&&f.isFunction(a)&&a(s.messageId),n&&f.isFunction(n)&&n()):toastr.error("出错了，请重试！")},error:function(){toastr.error("服务器异常，请稍后再试！")}})},render:function(){var s=this;template.defaults.imports.iconType=function(e){switch(e){case"SYSTEM":return"fa-desktop system";case"TASK":return"fa-tasks task";case"SETTING":return"fa-cog setting";case"EVENT":return"fa-calendar event";default:return"fa-comment-o other"}},template.defaults.imports.timeMsg=function(e){var t=new Date,a=e.split(/[- :/]/),n=new Date(a[0],a[1]-1,a[2],a[3],a[4],a[5]);return s.timeDistance(n,t)}},loading:function(){this.render(),f.ajax({url:t+"/message/messages",type:"GET",dataType:"JSON",data:{pageIndex:1,pageSize:5,data:{readFlag:0}},contentType:"application/json;charset=utf-8",success:function(e){e&&void 0!==e.pageList?f("#admui-messageContent").html(template("admui-messageTpl",e)):toastr.error(e.msg)},error:function(){toastr.error("服务器异常，请稍后再试！")}})},timeDistance:function(e,t){for(var a=t.getTime()-e.getTime(),n=0;n<6;n+=1)switch(n){case 0:if(1<=(a/=1e3)&&a<60)return a.toFixed(0)+"秒前";if(a<1)return"刚刚";break;case 1:if(0<=(a/=60)&&a<60)return a.toFixed(0)+"分钟前";break;case 2:if(0<=(a/=60)&&a<60)return a.toFixed(0)+"小时前";break;case 3:if(0<=(a/=24)&&a<60)return a.toFixed(0)+"天前";break;case 4:if(0<=(a/=30)&&a<60)return a.toFixed(0)+"月前";break;case 5:if(0<=(a/=365)&&a<60)return a.toFixed(0)+"年前"}}};(c.notifyFn=a).init(),f("#admui-navbarMessage > .msg-btn").on("click",function(){a.loading()}),f(e).on("click","#admui-messageContent > a",function(e){var t=f(this).data();a.readMsg(t),e.preventDefault()})}(window,document,jQuery);